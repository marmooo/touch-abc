import signaturePad from"https://cdn.jsdelivr.net/npm/signature_pad@5.0.1/+esm";let audioContext;const audioBufferCache={},canvasSize=140,maxWidth=4,repeatCount=3,defaultFontFamily="Roboto",googleFontsURL=new URL("https://fonts.googleapis.com/css2"),googleFontsParams=new URLSearchParams;googleFontsParams.set("family",defaultFontFamily),googleFontsParams.set("display","swap"),googleFontsURL.search=googleFontsParams;let fontFamily=defaultFontFamily,kanjis="",mode="uu",level=2,clearCount=0,englishVoices=[];loadVoices(),loadConfig();function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark"),localStorage.getItem("hint")==1&&(document.getElementById("hint").textContent="EASY"),localStorage.getItem("touch-abc-level")&&(level=parseInt(localStorage.getItem("touch-abc-level"))),localStorage.getItem("furigana")==1&&addFurigana()}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light"),boxes.forEach(e=>{[...e.shadowRoot.querySelectorAll("canvas")].forEach(e=>{e.removeAttribute("style")})})):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"),boxes.forEach(e=>{[...e.shadowRoot.querySelectorAll("canvas")].forEach(e=>{e.setAttribute("style","filter: invert(1) hue-rotate(180deg);")})}))}async function addFurigana(){const e=await import("https://marmooo.github.io/yomico/yomico.min.js");e.yomico("/touch-abc/drill/index.yomi")}function toggleHint(e){localStorage.getItem("hint")==1?(localStorage.setItem("hint",0),e.textContent="HARD"):(localStorage.setItem("hint",1),e.textContent="EASY"),toggleAllStroke()}function toggleScroll(){const e=document.getElementById("scrollOn"),t=document.getElementById("scrollOff");e.classList.contains("d-none")?(document.body.style.overflow="visible",e.classList.remove("d-none"),t.classList.add("d-none")):(document.body.style.overflow="hidden",e.classList.add("d-none"),t.classList.remove("d-none"))}function toggleVoice(){const e=document.getElementById("voiceOn"),t=document.getElementById("voiceOff");e.classList.contains("d-none")?(e.classList.remove("d-none"),t.classList.add("d-none")):(e.classList.add("d-none"),t.classList.remove("d-none"))}function createAudioContext(){return globalThis.AudioContext?new globalThis.AudioContext:(console.error("Web Audio API is not supported in this browser"),null)}function unlockAudio(){audioContext?audioContext.resume():(audioContext=createAudioContext(),loadAudio("stupid","/touch-abc/mp3/stupid5.mp3"),loadAudio("correct","/touch-abc/mp3/correct3.mp3"),loadAudio("correctAll","/touch-abc/mp3/correct1.mp3"),loadAudio("incorrect","/touch-abc/mp3/incorrect1.mp3")),document.removeEventListener("pointerdown",unlockAudio),document.removeEventListener("keydown",unlockAudio)}async function loadAudio(e,t){if(!audioContext)return;if(audioBufferCache[e])return audioBufferCache[e];try{const s=await fetch(t),o=await s.arrayBuffer(),n=await audioContext.decodeAudioData(o);return audioBufferCache[e]=n,n}catch(t){throw console.error(`Loading audio ${e} error:`,t),t}}function playAudio(e,t){if(!audioContext)return;const o=audioBufferCache[e];if(!o){console.error(`Audio ${e} is not found in cache`);return}const n=audioContext.createBufferSource();n.buffer=o;const s=audioContext.createGain();t&&(s.gain.value=t),s.connect(audioContext.destination),n.connect(s),n.start()}class ProblemBox extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.adoptedStyleSheets=[globalCSS];const e=document.getElementById("problem-box").content.cloneNode(!0);this.shadowRoot.appendChild(e)}}customElements.define("problem-box",ProblemBox);class TehonBox extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.adoptedStyleSheets=[globalCSS];const e=document.getElementById("tehon-box").content.cloneNode(!0);this.shadowRoot.appendChild(e),document.documentElement.getAttribute("data-bs-theme")=="dark"&&[...this.shadowRoot.querySelectorAll("canvas")].forEach(e=>{e.setAttribute("style","filter: invert(1) hue-rotate(180deg);")})}}customElements.define("tehon-box",TehonBox);class TegakiBox extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.adoptedStyleSheets=[globalCSS];const e=document.getElementById("tegaki-box").content.cloneNode(!0);this.shadowRoot.appendChild(e),document.documentElement.getAttribute("data-bs-theme")=="dark"&&[...this.shadowRoot.querySelectorAll("canvas")].forEach(e=>{e.setAttribute("style","filter: invert(1) hue-rotate(180deg);")})}}customElements.define("tegaki-box",TegakiBox);function fillTextBold(e,t,n,s){const o=estimateFontWidth(e,t,n,s),i=maxWidth*6;if(i<o)e.fillText(t,n,s);else{const r=i-o,a=Math.round(r/2);for(let o=-a;o<=a;o++)for(let i=-a;i<=a;i++)Math.round(Math.sqrt(o*o+i*i))<=r&&e.fillText(t,n+o,s+i)}}function estimateFontWidth(e,t,n,s){const o=maxWidth;e.fillText(t,n,s);const i=e.getImageData(0,0,canvasSize,canvasSize).data,a=countNoTransparent(i);e.fillText(t,n+o,s+o);const r=e.getImageData(0,0,canvasSize,canvasSize).data,c=getInclusionCount(r,i);return e.clearRect(0,0,canvasSize,canvasSize),maxWidth/(c/a)}function drawFont(e,t,n){const s=e.getContext("2d"),o=canvasSize*.8;s.font=`${o}px ${fontFamily}`;const a=s.measureText(t).width*.9,i=(canvasSize-a)/2;n?(s.fillStyle="lightgray",fillTextBold(s,t,i,o),toggleStroke(e)):s.fillText(t,i,o)}function loadFont(e,t,n,s,o){let i;o?i=new TegakiBox:i=new TehonBox,boxes.push(i);const a=i.shadowRoot.querySelector(".tehon");return a.setAttribute("alt",e),a.setAttribute("data-id",t),a.setAttribute("data-pos",s),drawFont(a,e,o),n.appendChild(i),a}function showKanjiScore(e,t,n){e=Math.floor(e),e>=80?playAudio("correct",.3):playAudio("incorrect",.3),t.classList.remove("d-none"),t.textContent=e,localStorage.getItem("hint")!=1&&(n.style.visibility="visible")}function getProblemScores(e,t,n){const s=[];return t.forEach((t,o)=>{const r=parseInt(t.dataset.pos),a=n[o].toData();let i=0;if(a.length!=0){const n=e.children[r].shadowRoot.querySelector(".score");i=getKanjiScore(a,t),showKanjiScore(i,n,t)}s[o]=i}),Promise.all(s)}function setScoringButton(e,t,n,s,o){const i=e.shadowRoot.querySelector(".scoring");i.addEventListener("click",()=>{getProblemScores(t,n,s).then(t=>{if(t.every(e=>e>=80)){clearCount+=1,e.shadowRoot.querySelector(".guard").style.height="100%";const t=e.nextElementSibling;if(t){const e=document.getElementById("voiceOn").classList.contains("d-none");e||loopVoice(kanjis[clearCount].toLowerCase(),repeatCount),t.shadowRoot.querySelector(".guard").style.height="0";const n=document.getElementById("header").offsetHeight,s=t.getBoundingClientRect().top+document.documentElement.scrollTop-n;globalThis.scrollTo({top:s,behavior:"smooth"})}}let n=localStorage.getItem("touch-abc");n||(n=""),t.forEach((e,t)=>{e<40&&(n=n.replace(o[t],""))}),localStorage.setItem("touch-abc",n)})})}function setSignaturePad(e){const t=e.parentNode.querySelector(".tegaki");return new signaturePad(t,{minWidth:2,maxWidth:2,penColor:"black",throttle:0,minDistance:0})}function setEraser(e,t,n,s){const o=s.getRootNode().host,i=[...t.children].findIndex(e=>e==o);n.children[i].shadowRoot.querySelector(".eraser").onclick=function(){const n=e.toData();n&&e.clear();const o=parseInt(s.dataset.pos),i=t.children[o].shadowRoot.querySelector(".score");i.classList.add("d-none"),localStorage.getItem("hint")!=1&&(s.style.visibility="hidden")}}function loadVoices(){const e=new Promise(e=>{let t=speechSynthesis.getVoices();if(t.length!==0)e(t);else{let n=!1;speechSynthesis.addEventListener("voiceschanged",()=>{n=!0,t=speechSynthesis.getVoices(),e(t)}),setTimeout(()=>{n||document.getElementById("noTTS").classList.remove("d-none")},1e3)}}),t=["com.apple.speech.synthesis.voice.Bahh","com.apple.speech.synthesis.voice.Albert","com.apple.speech.synthesis.voice.Hysterical","com.apple.speech.synthesis.voice.Organ","com.apple.speech.synthesis.voice.Cellos","com.apple.speech.synthesis.voice.Zarvox","com.apple.speech.synthesis.voice.Bells","com.apple.speech.synthesis.voice.Trinoids","com.apple.speech.synthesis.voice.Boing","com.apple.speech.synthesis.voice.Whisper","com.apple.speech.synthesis.voice.Deranged","com.apple.speech.synthesis.voice.GoodNews","com.apple.speech.synthesis.voice.BadNews","com.apple.speech.synthesis.voice.Bubbles"];e.then(e=>{englishVoices=e.filter(e=>e.lang=="en-US").filter(e=>!t.includes(e.voiceURI))})}function loopVoice(e,t){const n=new globalThis.SpeechSynthesisUtterance(e);n.voice=englishVoices[Math.floor(Math.random()*englishVoices.length)],n.lang="en-US";for(let e=0;e<t;e++)speechSynthesis.speak(n)}function setSound(e,t,n){const s=parseInt(t.dataset.pos),o=e.children[s].shadowRoot.querySelector(".sound");o.onclick=()=>loopVoice(n.toLowerCase(),repeatCount)}function loadProblem(e,t){const n=new ProblemBox,i=n.shadowRoot,a=[],r=[],s=i.querySelector(".tehon"),o=i.querySelector(".tegaki");for(let n=0;n<e.length;n++){loadFont(e[n],e[n],s,n,!1);const i=loadFont(t[n],t[n],o,n,!0),c=setSignaturePad(i);a.push(i),r.push(c),setEraser(c,o,s,i),setSound(s,i,e[n])}setScoringButton(n,o,a,r,e),document.getElementById("problems").appendChild(n)}function toggleAllStroke(){const e=document.getElementById("problems").children;for(const t of e){const n=t.shadowRoot.querySelector(".tegaki").children;for(const e of n){const t=e.shadowRoot.querySelector(".tehon");toggleStroke(t)}}}function toggleStroke(e){localStorage.getItem("hint")!=1?e.style.visibility="hidden":e.style.visibility="visible"}function countNoTransparent(e){let t=0;for(let n=3;n<e.length;n+=4)e[n]!=0&&(t+=1);return t}function getInclusionCount(e,t){for(let n=3;n<e.length;n+=4)t[n]!=0&&(e[n]=0);const n=countNoTransparent(e);return n}function getScoringFactor(e){switch(e){case 0:return.5**2;case 1:return.6**2;case 2:return.7**2;case 3:return.8**2;case 4:return.9**2;default:return.7**2}}function calcKanjiScore(e,t,n){let o=1-Math.abs((t-e)/t);o>1&&(o=1);let i=(e-n)/e;i>1&&(i=1);let s=o*i*100/getScoringFactor(level);return s<0&&(s=0),s>100&&(s=100),isNaN(s)&&(s=0),s}function getKanjiScore(e,t){const n=maxWidth*3;e.forEach(e=>{e.minWidth=n,e.maxWidth=n});const s=document.createElement("canvas");s.setAttribute("width",canvasSize),s.setAttribute("height",canvasSize);const a=s.getContext("2d",{willReadFrequently:!0}),r=new signaturePad(s,{minWidth:n,maxWidth:n,penColor:"black"});r.fromData(e);const o=a.getImageData(0,0,canvasSize,canvasSize).data,c=countNoTransparent(o),i=t.getContext("2d").getImageData(0,0,canvasSize,canvasSize).data,l=countNoTransparent(i),d=getInclusionCount(o,i),u=calcKanjiScore(c,l,d);return u}function report(){const e=[],n=document.getElementById("problems").children;for(let t=0;t<n.length;t++){const s=n[t].shadowRoot.querySelector(".tegaki").children;for(let t=0;t<s.length;t++){const n=s[t].shadowRoot.querySelector(".score").textContent;e.push(parseInt(n))}}let t=0;for(let n=0;n<e.length;n++)t+=e[n];if(t/=e.length,t>=80){playAudio("correctAll");let e=localStorage.getItem("touch-abc");e?(kanjis.split("").forEach(t=>{e.includes(t)||(e+=t)}),localStorage.setItem("touch-abc",e)):localStorage.setItem("touch-abc",kanjis),document.getElementById("report").classList.add("d-none"),document.getElementById("correctReport").classList.remove("d-none"),setTimeout(()=>{location.href="/touch-abc/"},3e3)}else playAudio("stupid"),document.getElementById("report").classList.add("d-none"),document.getElementById("incorrectReport").classList.remove("d-none"),setTimeout(()=>{document.getElementById("report").classList.remove("d-none"),document.getElementById("incorrectReport").classList.add("d-none")},6e3)}function convUpperLower(e){res="";for(let t=0;t<e.length;++t)c=e[t],c==c.toUpperCase()?res+=c.toLowerCase():c==c.toLowerCase()?res+=c.toUpperCase():res+=c;return res}async function loadGoogleFonts(e){const n=[...new Set(kanjis)].join(""),t=new URLSearchParams;t.set("family",e),t.set("text",n),t.set("display","swap"),googleFontsURL.search=t;const s=await fetch(googleFontsURL),o=await s.text(),i=o.match(/url\(.+?\)/g);for(const n of i){const t=new FontFace(e,n);await t.load(),document.fonts.add(t)}}function initDrill(){let e,t;if(kanjis)if(mode=="conv"){const n=convUpperLower(kanjis);e=kanjis.split(""),t=n.split("")}else e=kanjis.split(""),t=kanjis.split("");else{const s=Array.from("ABCDEFGHIJKLMNOPQRSTUVWXYZ"),n=Array.from("abcdefghijklmnopqrstuvwxyz");mode=="uu"?(e=s,t=s):mode=="ul"?(e=s,t=n):mode=="ll"?(e=n,t=n):(e=n,t=s),kanjis=n.join("")}for(let n=0;n<e.length;n++)loadProblem(e[n],t[n]);document.getElementById("problems").children[0].shadowRoot.querySelector(".guard").style.height="0"}function initQuery(){const e=new URLSearchParams(location.search);kanjis=e.get("q"),mode=e.get("mode")}async function initFonts(){let e=localStorage.getItem("touch-abc-font");e||(e=googleFontsURL.toString());try{const t=new URL(e);if(t.host==googleFontsURL.host)fontFamily=t.searchParams.get("family"),await loadGoogleFonts(fontFamily);else{fontFamily="abc";const t=new FontFace(fontFamily,`url(${e})`);await t.load(),document.fonts.add(t)}}catch(e){console.log(e)}}function getGlobalCSS(){let e="";for(const t of document.styleSheets)try{for(const n of t.cssRules)e+=n.cssText}catch{}const t=new CSSStyleSheet;return t.replaceSync(e),t}const boxes=[];initQuery(),await initFonts();const globalCSS=getGlobalCSS();initDrill(),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("toggleScroll").onclick=toggleScroll,document.getElementById("toggleVoice").onclick=toggleVoice,document.getElementById("hint").onclick=toggleHint,document.getElementById("reportButton").onclick=report,document.addEventListener("pointerdown",unlockAudio,{once:!0}),document.addEventListener("keydown",unlockAudio,{once:!0})